angular.module("ionic.metApp").controller("HomeCtrl",["metApi","$scope","$timeout","$rootScope","Weather","Geo","Flickr","$ionicModal","$ionicPlatform","$ionicPopup","$interval","$ionicBackdrop","$state","$ionicHistory","$route","metCodes",function(t,e,a,n,o,c,m,s,u,g,l,d,f,_,h,p){e.activeBgImageIndex=0,e.isFlipped=!1,n.t="Today",setTimeout(function(){"Tobago"==n.c&&e.flip("Tobago")},1e3),e.set_due_point=function(t,e){var a=e[t].value,n=/([0-9\.]+)%/g;return(r=n.exec(a))[0]},e.cTemp=function(t){var a="";return(29>t&&"night"!=e.timeOfDay()||23>t&&"night"==e.timeOfDay)&&(a="cool "+("night"!=e.timeOfDay()?"day":"night")),(t>=29&&31>=t&&"night"!=e.timeOfDay()||t>=23&&26>=t&&"night"==e.timeOfDay())&&(a="warm "+("night"!=e.timeOfDay()?"day":"night")),(t>=32&&34>=t&&"night"!=e.timeOfDay()||t>=27&&29>=t&&"night"==e.timeOfDay())&&(a="hot "+("night"!=e.timeOfDay()?"day":"night")),(t>34&&"night"!=e.timeOfDay()||t>29&&"night"==e.timeOfDay())&&(a="very hot "+("night"!=e.timeOfDay()?"day":"night")),a},e.cWind=function(t){var a="",n=t;t=t.substring(t.lastIndexOf("(")+1,t.lastIndexOf(";")),t=parseInt(t);var o=(1.15077945*t).toFixed(0)+" MPH",r=n.split("(",1)+"at "+o;return t>=0&&3>=t&&(a="Calm/Still winds coming "+r),t>=4&&10>=t&&(a="Gentle breeze "+r),t>=11&&16>=t&&(a="Moderate breeze "+r),t>=17&&21>=t&&(a="Windy breeze "+r),t>=22&&27>=t&&(a="Strong Winds "+r),t>=28&&33>=t&&(a="Very Strong Winds "+r),t>=34&&62>=t&&(a="Storm Force Winds "+r),t>63&&(a="Hurricane force winds "+r),isNaN(t)&&(a=e.capFLetter(n)),a},e.showAlert=function(t,e){g.alert({title:t,template:e})},e.flip=function(t){e.isFlipped=!e.isFlipped,"Trinidad"==t?n.ref_trin():n.ref_bago()},e.$on("$ionicView.beforeEnter",function(){}),e.$on("$ionicView.enter",function(){}),e.closeModal=function(t){e.modal.hide()},e.myGoBack=function(){_.goBack()},e.$on("modal.hidden",function(){d.release()}),e.timeOfDay=function(){var t=new Date,e=t.getHours(),a="";return e>=0&&12>e?a="morning":e>=12&&17>e?a="mid day":e>=17&&18>e?a="evening":e>=18&&(a="night"),a},e.hourOfDay=function(){var t=new Date,a=t.getHours();return a>=0&&12>=a&&(a=(0==a?"12":a)+":"+e.minuteOfDay()+" am",12==t.getHours()&&e.minuteOfDay()>"01"&&(a=t.getHours()+":"+e.minuteOfDay()+" pm")),a>12&&(a=a-12+":"+e.minuteOfDay()+" pm"),a},e.minuteOfDay=function(){var t=new Date;return t.getMinutes()<10?"0"+t.getMinutes():t.getMinutes()},e.searchTag=function(){var t=e.timeOfDay(),a=new Date,n=a.getHours();return"morning"==t&&n>5&&7>n&&(t="sunrise"),n>=0&&5>=n&&(t="night"),"morning"==t&&(t="mid day"),t},e.my_date=function(){var t=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],e=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],a=new Date;return[e[a.getDay()],a.getDate(),t[a.getMonth()],a.getFullYear()]},e.day_string=function(t){var e=new Date,a=["Sun","Mon","Tue","Wed","Thu","Fri","Sat","Sun","Mon"];return a[e.getDay()+t]},e.convertTimestamp=function(t){var e=new Date(1e3*t),a=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],n=e.getFullYear(),o=a[e.getMonth()],r=e.getDate(),i=e.getHours(),c=e.getMinutes(),m=e.getSeconds(),s=r+" "+o+" "+n+" "+i+":"+c+":"+m;return s},e.getAverageRGB=function(t,e){var a,n,o,r,i=5,c=document.createElement("canvas"),m=c.getContext&&c.getContext("2d"),s=-4,u={r:0,g:0,b:0},g=0,l=0;if(!m)return defaultrgb;for(o=c.height=t.naturalHeight||t.offsetHeight||t.height,n=c.width=t.naturalWidth||t.offsetWidth||t.width,m.drawImage(t,0,0),a=m.getImageData(0,0,n,o),r=a.data.length;(s+=4*i)<r;)++g,u.r+=a.data[s],u.g+=a.data[s+1],u.b+=a.data[s+2],l+=.34*u.r+.5*u.g+.16*u.b,0!==l&&(l/=2);if(l>.5);else;u.r=~~(u.r/g),u.g=~~(u.g/g),u.b=~~(u.b/g),$(e+".of1").css("background-color","rgba("+[u.r,u.g,u.b,.9].join(", ")+")")},e.capFLetter=function(t){return t.charAt(0).toUpperCase()+t.slice(1).toLowerCase()},e.is_word_in_string=function(t,e){return new RegExp("\\b"+e+"\\b","i").test(t)},e.inArray=function(t,e){for(i=0;i<e.length;i++)if(e[i]==t)return e[i];return!1},e.metars_cloud=p.all(),n.go_toForecastHome=function(){f.go("app.forecast_home",{})},n.get_fcast=function(){t.get_forecast(function(t){n.fcast_result=t.items[0],n.$emit("f_cast_ready",n.fcast_result)})},n.get_metars=function(){t.get_metar(function(t){n.metars_result=t.items,n.$emit("forecast_loaded",n.metars_result)})},n.globalRefresh=function(){n.get_fcast(),n.get_metars()},n.get_fcast(),n.get_metars()}]).controller("TrinCtrl",["metApi","$scope","$timeout","$rootScope","Weather","Geo","Flickr","$ionicModal","$ionicPlatform","$ionicPopup","$interval","$ionicBackdrop","$state","$ionicHistory","$route","$window","$ionicLoading","$localstorage","$cordovaDialogs","metTT","$ionicPopover",function(t,e,a,n,o,r,c,m,s,u,g,l,d,f,_,h,p,y,v,b,T){function w(t,e){return(" "+t.className+" ").indexOf(" "+e+" ")>-1}var D=this;g(function(){e.token=n.token,void 0!=n.token},5e3),e.fcasttrin="night"==e.timeOfDay()?"fair-night":"fair",e.fcastbago="sunny";var $=6e5;g(function(){f.clearCache().then(function(){_.reload(),D.refreshData(),n.get_fcast(),n.get_metars(),D.getBackgroundImage("Trinidad, "+e.searchTag())}),f.clearHistory()},$),n.ref_trin=function(){D.refreshData()},e.refreshImgTrin=function(){D.getBackgroundImage("Trinidad, "+e.searchTag()),e.popover.hide()},e.closePopover=function(){e.popover.hide()},D.refreshData=function(){a(function(){D.get_uv_index()},1e3),D.getCurrent(null,null),D.trin_3day(),f.clearCache().then(function(){_.reload()})},D.getCurrent=function(t,a){n.$broadcast("scroll.refreshComplete"),e.today=e.my_date()},D.cycleBgImages=function(){a(function(){if(e.bgImages){var t=Math.floor(Math.random()*e.bgImages.length)+0;e.activeBgImage=e.bgImages[t],a(function(){e.getAverageRGB(document.querySelector("#i-trin"),".trin")},2e3)}})},this.getBackgroundImage=function(t){c.search(t).then(function(t){var a=t.photos;e.bgImages=a.photo,D.cycleBgImages()},function(t){console.log("Unable to get Flickr images",t)})},D.get_uv_index=function(){var a=[],n=new Date;e.has_index=!0;var o=document.getElementById("uv-index"),r=n.getDate()+"."+(n.getMonth()+1<9?"0"+(n.getMonth()+1):n.getMonth()+1)+"."+n.getFullYear();g(function(){e.hour_of_day=e.hourOfDay()},300);var i=["c1","c2","c3","c4","c5","c6","c7","c8","c9","c10","c11"];if(t.get_uv_index(function(t){for(var n=0;n<t.items.length;n++){var c=t.items[n].uv_date.trim();r==c&&a.push(t.items[n])}if(a.length){e.uv_index=a[a.length-1];var m=Number(e.uv_index.uv_value),n=m.toFixed(0);e.uv_index.uv_value=n;var s=0==n||1==n?0:11==n||n>11?10:n-1;for(e.uv_color=i[s],x=0;x<i.length;x++)w(o,i[x])&&o.classList.remove(i[x]);e.$watch("uv_color",function(){o.className=o.className+"  "+e.uv_color})}}),!a.length){e.has_index=!1;var c=[{uv_value:0}];e.uv_index=c[0],o.className=o.className+" c1"}},e.current_temp_trin="Loading..",n.$on("forecast_loaded",function(t,a){var n=a,o=b.all();D.mdata=[];var r=0;for(i=0;i<n.length;i++)"TTPP"==n[i].station&&o[r]&&(D.mdata.push({id:n[r].id,label:n[r].label.replace(":",""),station:n[r].station,value:n[r].value,icon:o[r].icon,el:o[r].el,show:o[r].show}),r++);e.current_temp_trin=D.mdata[2].value.substring(0,3),D.mdata[2].txt="Feels like a "+e.cTemp(Number(e.current_temp_trin)),D.mdata[5].value=e.cWind(D.mdata[5].value),e.dew_point_trin=e.set_due_point(3,D.mdata);var c=[];for(i=0;i<e.metars_cloud.length;i++)D.mdata[1].value.indexOf(e.metars_cloud[i].code)>-1&&c.push(e.metars_cloud[i].code);for(e.cc,i=0;i<c.length;i++)for("FEW"==c[i]&&(e.inArray("SCT",c)||e.inArray("BKN",c)||e.inArray("OVC",c)||(e.cc="FEW")),"SCT"==c[i]&&(e.inArray("BKN",c)||e.inArray("OVC",c)||(e.cc="SCT")),e.inArray("BKN",c)&&(e.cc="BKN"),e.inArray("OVC",c)&&(e.cc="OVC"),x=0;x<e.metars_cloud.length;x++)c[c.length-1]==e.metars_cloud[x].code&&(e.cc=e.metars_cloud[x].code);var m="";for(x=0;x<e.metars_cloud.length;x++)e.cc==e.metars_cloud[x].code&&(m=e.metars_cloud[x].desc,e.summary_text_trin=m);m||(m="Clear",e.summary_text_trin=m);var s=new Date;if(e.fcasttrin="Clear"==m?"clear-"+e.timeOfDay():m,"Clear"==m&&parseInt(s.getHours())>=0&&parseInt(s.getHours())<=5&&(e.fcasttrin="clear-night"),D.mdata[1].value.indexOf("NOSIG")>-1){var u=e.summary_text_trin;e.summary_text_trin=e.capFLetter(u)}else e.summary_text_trin=e.capFLetter(D.mdata[9].value.match(/\(([^)]+)\)/)[1]).replace("(","");if(e.summary_text_trin.indexOf("Haze")>-1&&(e.summary_text_trin="Dust, smoke and other dry particles may be in the air"),e.fcasttrin.indexOf("Cloudy")>-1||e.fcasttrin.indexOf("cloudy")>-1){var g="night"==e.timeOfDay()?"-night":"";e.fcasttrin=e.fcasttrin+g,parseInt(s.getHours())>=0&&parseInt(s.getHours())<=5&&(e.fcasttrin=e.fcasttrin+"-night")}console.debug("trin summary",e.summary_text_trin)}),e.showMetarsTrin=function(){l.retain(),e.mettrin_modal?e.mettrin_modal.show():m.fromTemplateUrl("app/home/metars-trin.html",function(t){e.mettrin_modal=t,e.mettrin_modal.show()},{animation:"slide-in-up"})},e.open_trin_popover=function(t){T.fromTemplateUrl("app/home/trin_popover.html",{scope:e}).then(function(a){e.popover=a,e.popover.show(t)})},D.trin_3day=function(t){e.tm=e.day_string(1),e.nd=e.day_string(2),n.$on("f_cast_ready",function(t,a){var o=a;D.ftime_trin=o.forecastTime,"05:30PM"==D.ftime_trin&&(y.setObject("530pm_fcast",o),n.t="Tonight",D.th=o.PiarcoFcstMxTemp,D.tl=o.PiarcoFcstMnTemp,D.maxtm=o.TmPiarcoMxTemp,D.mintm=o.TmPiarcoMnTemp,e.trin_tm_icon=o.TmWeatherPiarcoMx?o.TmWeatherPiarcoMx:"sunny",D.max24=o.maxTrin24look,D.min24=o.minTrin24look,e.trin_24_icon=o.wx24?o.wx24:"sunny"),"05:30PM"!=D.ftime_trin&&(D.th=o.PiarcoFcstMxTemp,D.tl=o.TmPiarcoMnTemp,D.maxtm=o.maxTrin24look,D.mintm=o.minTrin24look,e.trin_tm_icon=o.wx24?o.wx24:"sunny",D.max24=o.maxTrin48look,D.min24=o.minTrin48look,e.trin_24_icon=o.wx48?o.wx48:"sunny"),e.trin_icon_today=o.imageTrin?o.imageTrin:"sunny",D.sunup=o.sunrise,D.sundown=o.sunset})},D.refreshData(),D.getBackgroundImage("Trinidad, "+e.searchTag())}]).controller("BagoCtrl",["metApi","$scope","$timeout","$rootScope","Weather","Geo","Flickr","$ionicModal","$ionicPlatform","$ionicPopup","$interval","$ionicBackdrop","$state","$ionicHistory","$route","$ionicLoading","$localstorage","metTB","$ionicPopover",function(t,e,a,n,o,r,c,m,s,u,g,l,d,f,_,h,p,y,v){var b=this;e.fcastbago="sunny";var T=6e5;g(function(){f.clearCache().then(function(){b.refreshData(),_.reload(),b.getBackgroundImage("Tobago, "+e.searchTag())}),f.clearHistory()},T),n.ref_bago=function(){b.refreshData()},e.open_bago_popover=function(t){v.fromTemplateUrl("app/home/bago_popover.html",{scope:e}).then(function(a){e.popover=a,e.popover.show(t)})},e.refreshImgBago=function(){b.getBackgroundImage("Tobago, "+e.searchTag()),e.popover.hide()},e.closePopover=function(){e.popover.hide()},b.refreshData=function(){b.getCurrent(null,null),b.bago_3day(),b.set_time_bubble()},b.getCurrent=function(t,a){e.today=e.my_date(),n.$broadcast("scroll.refreshComplete")},b.cycleBgImages=function(){a(function(){if(e.bgImages){var t=Math.floor(Math.random()*e.bgImages.length)+0;e.activeBgImage=e.bgImages[t],setTimeout(function(){e.getAverageRGB(document.querySelector("#i-bago"),".bago")},2e3)}})},this.getBackgroundImage=function(t){c.search(t).then(function(t){var a=t.photos;e.bgImages=a.photo,b.cycleBgImages()},function(t){console.log("Unable to get Flickr images",t)})},e.current_temp="Loading..",n.$on("forecast_loaded",function(t,a){var n=a,o=y.all();b.mdatab=null,b.mdatab=[];var r=0;for(i=0;i<n.length;i++)"TTCP"==n[i].station&&(b.mdatab.push({id:n[i].id,label:n[i].label,station:n[i].station,value:n[i].value,icon:void 0!=o[r]?o[r].icon:"",el:void 0!=o[r]?o[r].el:"",show:void 0!=o[r]?o[r].show:""}),r++);e.current_temp=b.mdatab[2].value.substring(0,3),b.mdatab[2].txt="Looks like a "+e.cTemp(Number(e.current_temp)),b.mdatab[5].value=e.cWind(b.mdatab[5].value),e.dew_point=e.set_due_point(3,b.mdatab);var c=[];for(i=0;i<e.metars_cloud.length;i++)b.mdatab[1].value.indexOf(e.metars_cloud[i].code)>-1&&c.push(e.metars_cloud[i].code);for(e.cd,i=0;i<c.length;i++)for("FEW"==c[i]&&(e.inArray("SCT",c)||e.inArray("BKN",c)||e.inArray("OVC",c)||(e.cc="FEW")),"SCT"==c[i]&&(e.inArray("BKN",c)||e.inArray("OVC",c)||(e.cc="SCT")),e.inArray("BKN",c)&&(e.cc="BKN"),e.inArray("OVC",c)&&(e.cc="OVC"),x=0;x<e.metars_cloud.length;x++)c[c.length-1]==e.metars_cloud[x].code&&(e.cd=e.metars_cloud[x].code);var m="";for(x=0;x<e.metars_cloud.length;x++)e.cd==e.metars_cloud[x].code&&(m=e.metars_cloud[x].desc,e.summary_text=m);m||(m="Clear",e.summary_text=m);var s=new Date;if(e.fcastbago="Clear"==m?"clear-"+e.timeOfDay():m,"Clear"==m&&parseInt(s.getHours())>=0&&parseInt(s.getHours())<=5&&(e.fcastbago="clear-night"),b.mdatab[1].value.indexOf("NOSIG")>-1){var u=e.summary_text;e.summary_text=e.capFLetter(u)}else e.summary_text=e.capFLetter(b.mdatab[9].value.match(/\(([^)]+)\)/)[1]).replace("(","");if(e.summary_text.indexOf("Haze")>-1&&(e.summary_text="Dust, smoke and other dry particles may be in the air"),e.fcastbago.indexOf("Cloudy")>-1||e.fcastbago.indexOf("cloudy")>-1){var g="night"==e.timeOfDay()?"-night":"";e.fcastbago=e.fcastbago+g,parseInt(s.getHours())>=0&&parseInt(s.getHours())<=5&&(e.fcastbago=e.fcastbago+"-night")}}),b.set_time_bubble=function(){{var t=new Date;t.getDate()+"."+(t.getMonth()+1)+"."+t.getFullYear()}e.hour_of_day=e.hourOfDay()},e.showMetarsBago=function(){l.retain(),e.metbago_modal?e.metbago_modal.show():m.fromTemplateUrl("app/home/metars-bago.html",function(t){e.metbago_modal=t,e.metbago_modal.show()},{animation:"slide-in-up"})},b.bago_3day=function(t){e.tm=e.day_string(1),e.nd=e.day_string(2);var a=[];n.$on("f_cast_ready",function(t,n){a=n,b.ftime_bago=a.forecastTime,"05:30PM"==b.ftime_bago&&(p.setObject("530pm_fcast",a),b.th=a.CrownFcstMxTemp?a.CrownFcstMxTemp:" - ",b.tl=a.CrownFcstMnTemp?a.CrownFcstMnTemp:" - ",b.maxtm=a.TmCrownMxTemp,b.mintm=a.TmCrownMnTemp,e.bago_tm_icon=a.TmWeatherCpMx?a.TmWeatherCpMx:"sunny",b.max24=a.maxTob24look,b.min24=a.minTob24look,e.bago_24_icon=a.wx24cp?a.wx48cp:"sunny"),"05:30PM"!=b.ftime_bago&&(b.th=a.CrownFcstMxTemp?a.CrownFcstMxTemp:" - ",ff=p.getObject("530pm_fcast"),b.tl=a.TmCrownMnTemp?a.TmCrownMnTemp:" - ",b.maxtm=a.maxTob24look,b.mintm=a.minTob24look,e.bago_tm_icon=a.wx24cp?a.wx24cp:"sunny",b.max24=a.maxTob48look,b.min24=a.minTob48look,e.bago_24_icon=a.wx48cp?a.wx48cp:"sunny"),e.bago_icon_today=a.imagebago})},b.refreshData(),b.getBackgroundImage("Tobago, "+e.searchTag())}]);