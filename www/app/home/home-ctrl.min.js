angular.module("ionic.metApp").directive("interval_tracker",["$interval","dateFilter",function(e,t){return function(n,o,r){function s(){console.log(t(new Date,a))}var a,c;n.$watch(r.interval_tracker,function(e){a=e,s()}),c=e(s,1e3)}}]).controller("HomeCtrl",function(e,t,n,o,r,s,a,c,l,g,u){function h(){var e=new Date,t=e.getHours(),n="";return t>=6&&12>t?n="morning":t>=12&&18>t?n="mid day":t>=18&&(n="night"),n}function m(e){var t=new Date(1e3*e),n=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],o=t.getFullYear(),r=n[t.getMonth()],s=t.getDate(),a=t.getHours(),c=t.getMinutes(),i=t.getSeconds(),l=s+" "+r+" "+o+" "+a+":"+c+":"+i;return l}var f=this;u(function(){},1e3),t.activeBgImageIndex=0,t.has_images=!1,this.getCurrent=function(e,n){r.getAtLocation(e,n).then(function(r){t.current=r.data,console.log("Got Current",t.current),o.$broadcast("scroll.refreshComplete");var s=h(),a=m(t.current.currently.time);t.time=a,console.log(a),window.localStorage.last_resfrsh=a,t.last_refresh=window.localStorage.getItem("last_refresh"),f.getBackgroundImage(e,n,t.current.currently.summary+", "+t.current.daily.icon+", hq, trinidad, "+s)},function(e){var n="";switch(e.status){case 404:n="No network connection"}t.showAlert("Unable to get current conditions",n),console.log(e),o.$broadcast("scroll.refreshComplete")})},t.refreshData=function(){s.getLocation().then(function(e){var n=e.coords.latitude,o=e.coords.longitude;s.reverseGeocode(n,o).then(function(e){t.currentLocationString=e}),f.getCurrent(n,o)},function(e){t.showAlert("Unable to get current location",e.message),t.currentLocationString="Unable to get current location:"+e,o.$broadcast("scroll.refreshComplete")})},t.showAlert=function(e,t){g.alert({title:e,template:t})},this.cycleBgImages=function(){n(function(){t.bgImages&&(console.log("in function that uses the image"),console.log(t.bgImages),t.activeBgImage=t.bgImages[t.activeBgImageIndex++%t.bgImages.length])})},this.getBackgroundImage=function(e,n,o){t.bgImages;console.log("Has images: "+t.has_images),t.has_images?(console.log("we have loaded images"),f.cycleBgImages()):a.search(o,e,n).then(function(e){var n=e.photos,o=[];if(n.photo.length){for(t.bgImages=n.photo,i=0;i<20;i++)o.push({i:t.bgImages[i]});console.log("photo store empty"),f.cycleBgImages(),t.has_images=!0}},function(e){console.log("Unable to get Flickr images",e)})},t.refreshData(),f.getForecast=function(){e.get_forecast(function(e){})},f.getForecast(),t.yForecast=function(){e.yahooForecast(function(e){console.log(e),f.condition=e.query.results.channel.item.condition,f.threeDay=e.query.results.channel.item.forecast,f.location=e.query.results.channel.location.city,f.pubDate=e.query.results.channel.item.pubDate,f.title=e.query.results.channel.item.title,f.sunrise=e.query.results.channel.astronomy.sunrise,f.sunset=e.query.results.channel.astronomy.sunset})},t.showSettings=function(){t.settingsModal?t.settingsModal.show():c.fromTemplateUrl("settings.html",function(e){t.settingsModal=e,t.settingsModal.show()},{animation:"scale-in"})}}).controller("SettingsCtrl",function(e,t){e.setings=t.getSettings(),e.$watch("settings",function(e){t.save()},!0),e.closeSettings=function(){e.modal.hide(),t.save()},e.changeCurrentTemp=function(e){t.set("tempUnits",e),t.save(e)}});