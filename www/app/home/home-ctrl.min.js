angular.module("ionic.metApp").controller("HomeCtrl",["metApi","$scope","$timeout","$rootScope","Weather","Geo","Flickr","$ionicModal","$ionicPlatform","$ionicPopup","$interval","$ionicBackdrop","$state","$ionicHistory","$route","metCodes",function(t,e,a,n,o,c,m,s,u,l,g,d,f,_,h,y){e.activeBgImageIndex=0,e.isFlipped=!1,n.t="Today",setTimeout(function(){"Tobago"==n.c&&e.flip("Tobago")},1e3),e.set_due_point=function(t,e){var a=e[t].value,n=/([0-9\.]+)%/g;return(r=n.exec(a))[0]},e.cTemp=function(t){var a="";return(29>t&&"night"!=e.timeOfDay()||23>t&&"night"==e.timeOfDay)&&(a="cool "+("night"!=e.timeOfDay()?"day":"night")),(t>=29&&31>=t&&"night"!=e.timeOfDay()||t>=23&&26>=t&&"night"==e.timeOfDay())&&(a="warm "+("night"!=e.timeOfDay()?"day":"night")),(t>=32&&34>=t&&"night"!=e.timeOfDay()||t>=27&&29>=t&&"night"==e.timeOfDay())&&(a="hot "+("night"!=e.timeOfDay()?"day":"night")),(t>34&&"night"!=e.timeOfDay()||t>29&&"night"==e.timeOfDay())&&(a="very hot "+("night"!=e.timeOfDay()?"day":"night")),a},e.cWind=function(t){var a="",n=t;t=t.substring(t.lastIndexOf("(")+1,t.lastIndexOf(";")),t=parseInt(t);var r=(1.15077945*t).toFixed(0)+" MPH",i=n.split("(",1)+"at "+r;return t>=0&&3>=t&&(a="Calm/Still winds coming "+i),t>=4&&10>=t&&(a="Gentle breeze "+i),t>=11&&16>=t&&(a="Moderate breeze "+i),t>=17&&21>=t&&(a="Windy breeze "+i),t>=22&&27>=t&&(a="Strong Winds "+i),t>=28&&33>=t&&(a="Very Strong Winds "+i),t>=34&&62>=t&&(a="Storm Force Winds "+i),t>63&&(a="Hurricane force winds "+i),isNaN(t)&&(a=e.capFLetter(n)),a},e.showAlert=function(t,e){l.alert({title:t,template:e})},e.flip=function(t){e.isFlipped=!e.isFlipped,"Trinidad"==t?n.ref_trin():n.ref_bago()},e.$on("$ionicView.beforeEnter",function(){}),e.$on("$ionicView.enter",function(){}),e.closeModal=function(t){e.modal.hide()},e.myGoBack=function(){_.goBack()},e.$on("modal.hidden",function(){d.release()}),e.timeOfDay=function(){var t=new Date,e=t.getHours(),a="";return e>=0&&12>e?a="morning":e>=12&&17>e?a="mid day":e>=17&&18>e?a="evening":e>=18&&(a="night"),a},e.hourOfDay=function(){var t=new Date,a=t.getHours();return a>=0&&12>=a&&(a=(0==a?"12":a)+":"+e.minuteOfDay()+" am",12==t.getHours()&&e.minuteOfDay()>"01"&&(a=t.getHours()+":"+e.minuteOfDay()+" pm")),a>12&&(a=a-12+":"+e.minuteOfDay()+" pm"),a},e.minuteOfDay=function(){var t=new Date;return t.getMinutes()<10?"0"+t.getMinutes():t.getMinutes()},e.searchTag=function(){var t=e.timeOfDay(),a=new Date,n=a.getHours();return"morning"==t&&n>5&&7>n&&(t="sunrise"),n>=0&&5>=n&&(t="night"),"morning"==t&&(t="mid day"),t},e.my_date=function(){var t=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],e=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],a=new Date;return[e[a.getDay()],a.getDate(),t[a.getMonth()],a.getFullYear()]},e.day_string=function(t){var e=new Date,a=["Sun","Mon","Tue","Wed","Thu","Fri","Sat","Sun","Mon"];return a[e.getDay()+t]},e.convertTimestamp=function(t){var e=new Date(1e3*t),a=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],n=e.getFullYear(),r=a[e.getMonth()],i=e.getDate(),o=e.getHours(),c=e.getMinutes(),m=e.getSeconds(),s=i+" "+r+" "+n+" "+o+":"+c+":"+m;return s},e.getAverageRGB=function(t,e){var a,n,r,i,o=5,c=document.createElement("canvas"),m=c.getContext&&c.getContext("2d"),s=-4,u={r:0,g:0,b:0},l=0,g=0;if(!m)return defaultrgb;for(r=c.height=t.naturalHeight||t.offsetHeight||t.height,n=c.width=t.naturalWidth||t.offsetWidth||t.width,m.drawImage(t,0,0),a=m.getImageData(0,0,n,r),i=a.data.length;(s+=4*o)<i;)++l,u.r+=a.data[s],u.g+=a.data[s+1],u.b+=a.data[s+2],g+=.34*u.r+.5*u.g+.16*u.b,0!==g&&(g/=2);if(g>.5);else;u.r=~~(u.r/l),u.g=~~(u.g/l),u.b=~~(u.b/l),$(e+".of1").css("background-color","rgba("+[u.r,u.g,u.b,.9].join(", ")+")")},e.capFLetter=function(t){return t.charAt(0).toUpperCase()+t.slice(1).toLowerCase()},e.is_word_in_string=function(t,e){return new RegExp("\\b"+e+"\\b","i").test(t)},e.inArray=function(t,e){for(i=0;i<e.length;i++)if(e[i]==t)return e[i];return!1},e.metars_cloud=y.all(),n.go_toForecastHome=function(){f.go("app.forecast_home",{})},n.get_fcast=function(){t.get_forecast(function(t){n.fcast_result=t.items[0],n.$emit("f_cast_ready",n.fcast_result)})},n.get_metars=function(){t.get_metar(function(t){n.metars_result=t.items,n.$emit("forecast_loaded",n.metars_result)})},n.globalRefresh=function(){n.get_fcast(),n.get_metars()},n.get_fcast(),n.get_metars()}]).controller("TrinCtrl",["metApi","$scope","$timeout","$rootScope","Weather","Geo","Flickr","$ionicModal","$ionicPlatform","$ionicPopup","$interval","$ionicBackdrop","$state","$ionicHistory","$route","$window","$ionicLoading","$localstorage","$cordovaDialogs","metTT",function(t,e,a,n,r,o,c,m,s,u,l,g,d,f,_,h,y,p,b,v){function T(t,e){return(" "+t.className+" ").indexOf(" "+e+" ")>-1}var w=this;l(function(){e.token=n.token,void 0!=n.token},5e3),e.fcasttrin="night"==e.timeOfDay()?"fair-night":"fair",e.fcastbago="sunny";var D=6e5;l(function(){f.clearCache().then(function(){_.reload(),w.refreshData(),n.get_fcast(),n.get_metars(),w.getBackgroundImage("Trinidad, "+e.searchTag())}),f.clearHistory()},D),n.ref_trin=function(){w.refreshData()},w.refreshData=function(){a(function(){w.get_uv_index()},1e3),w.getCurrent(null,null),w.trin_3day(),f.clearCache().then(function(){_.reload()})},w.getCurrent=function(t,a){n.$broadcast("scroll.refreshComplete"),e.today=e.my_date()},w.cycleBgImages=function(){a(function(){if(e.bgImages){var t=Math.floor(Math.random()*e.bgImages.length)+0;e.activeBgImage=e.bgImages[t],a(function(){e.getAverageRGB(document.querySelector("#i-trin"),".trin")},2e3)}})},this.getBackgroundImage=function(t){c.search(t).then(function(t){var a=t.photos;e.bgImages=a.photo,console.debug("from flickr",e.bgImages),w.cycleBgImages()},function(t){console.log("Unable to get Flickr images",t)})},w.get_uv_index=function(){var a=[],n=new Date;e.has_index=!0;var r=document.getElementById("uv-index"),i=n.getDate()+"."+(n.getMonth()+1<9?"0"+(n.getMonth()+1):n.getMonth()+1)+"."+n.getFullYear();l(function(){e.hour_of_day=e.hourOfDay()},300);var o=["c1","c2","c3","c4","c5","c6","c7","c8","c9","c10","c11"];if(t.get_uv_index(function(t){for(var n=0;n<t.items.length;n++){var c=t.items[n].uv_date.trim();i==c&&a.push(t.items[n])}if(a.length){e.uv_index=a[a.length-1];var m=Number(e.uv_index.uv_value),n=m.toFixed(0);e.uv_index.uv_value=n;var s=0==n||1==n?0:11==n||n>11?10:n-1;for(e.uv_color=o[s],x=0;x<o.length;x++)T(r,o[x])&&r.classList.remove(o[x]);e.$watch("uv_color",function(){r.className=r.className+"  "+e.uv_color})}}),!a.length){e.has_index=!1;var c=[{uv_value:0}];e.uv_index=c[0],r.className=r.className+" c1"}},n.$on("forecast_loaded",function(t,a){e.current_temp_trin="Loading..";var n=a,r=v.all();w.mdata=[];var o=0;for(i=0;i<n.length;i++)"TTPP"==n[i].station&&r[o]&&(w.mdata.push({id:n[o].id,label:n[o].label.replace(":",""),station:n[o].station,value:n[o].value,icon:r[o].icon,el:r[o].el,show:r[o].show}),o++);e.current_temp_trin=w.mdata[2].value.substring(0,3),w.mdata[2].txt="Feels like a "+e.cTemp(Number(e.current_temp_trin)),w.mdata[5].value=e.cWind(w.mdata[5].value),e.dew_point_trin=e.set_due_point(3,w.mdata);var c=[];for(i=0;i<e.metars_cloud.length;i++)w.mdata[1].value.indexOf(e.metars_cloud[i].code)>-1&&c.push(e.metars_cloud[i].code);for(e.cc,i=0;i<c.length;i++)for("FEW"==c[i]&&(e.inArray("SCT",c)||e.inArray("BKN",c)||e.inArray("OVC",c)||(e.cc="FEW")),"SCT"==c[i]&&(e.inArray("BKN",c)||e.inArray("OVC",c)||(e.cc="SCT")),e.inArray("BKN",c)&&(e.cc="BKN"),e.inArray("OVC",c)&&(e.cc="OVC"),x=0;x<e.metars_cloud.length;x++)c[c.length-1]==e.metars_cloud[x].code&&(e.cc=e.metars_cloud[x].code);var m="";for(x=0;x<e.metars_cloud.length;x++)e.cc==e.metars_cloud[x].code&&(m=e.metars_cloud[x].desc,e.summary_text_trin=m);m||(m="Clear",e.summary_text_trin=m);var s=new Date;if(e.fcasttrin="Clear"==m?"clear-"+e.timeOfDay():m,"Clear"==m&&parseInt(s.getHours())>=0&&parseInt(s.getHours())<=5&&(e.fcasttrin="clear-night"),w.mdata[1].value.indexOf("NOSIG")>-1){var u=e.summary_text_trin;e.summary_text_trin=e.capFLetter(u)}else e.summary_text_trin=e.capFLetter(w.mdata[9].value.match(/\(([^)]+)\)/)[1]).replace("(","");if(e.summary_text_trin.indexOf("Haze")>-1&&(e.summary_text_trin="Dust, smoke and other dry particles may be in the air"),e.fcasttrin.indexOf("Cloudy")>-1||e.fcasttrin.indexOf("cloudy")>-1){var l="night"==e.timeOfDay()?"-night":"";e.fcasttrin=e.fcasttrin+l,parseInt(s.getHours())>=0&&parseInt(s.getHours())<=5&&(e.fcasttrin=e.fcasttrin+"-night")}}),e.showMetarsTrin=function(){g.retain(),e.mettrin_modal?e.mettrin_modal.show():m.fromTemplateUrl("app/home/metars-trin.html",function(t){e.mettrin_modal=t,e.mettrin_modal.show()},{animation:"slide-in-up"})},w.trin_3day=function(t){e.tm=e.day_string(1),e.nd=e.day_string(2),n.$on("f_cast_ready",function(t,a){var r=a;w.ftime_trin=r.forecastTime,"05:30PM"==w.ftime_trin&&(p.setObject("530pm_fcast",r),n.t="Tonight",w.th=r.PiarcoFcstMxTemp,w.tl=r.PiarcoFcstMnTemp,w.maxtm=r.TmPiarcoMxTemp,w.mintm=r.TmPiarcoMnTemp,e.trin_tm_icon=r.TmWeatherPiarcoMx?r.TmWeatherPiarcoMx:"sunny",w.max24=r.maxTrin24look,w.min24=r.minTrin24look,e.trin_24_icon=r.wx24?r.wx24:"sunny"),"05:30PM"!=w.ftime_trin&&(w.th=r.PiarcoFcstMxTemp,w.tl=r.TmPiarcoMnTemp,w.maxtm=r.maxTrin24look,w.mintm=r.minTrin24look,e.trin_tm_icon=r.wx24?r.wx24:"sunny",w.max24=r.maxTrin48look,w.min24=r.minTrin48look,e.trin_24_icon=r.wx48?r.wx48:"sunny"),e.trin_icon_today=r.imageTrin?r.imageTrin:"sunny",w.sunup=r.sunrise,w.sundown=r.sunset})},w.refreshData(),w.getBackgroundImage("Trinidad, "+e.searchTag())}]).controller("BagoCtrl",["metApi","$scope","$timeout","$rootScope","Weather","Geo","Flickr","$ionicModal","$ionicPlatform","$ionicPopup","$interval","$ionicBackdrop","$state","$ionicHistory","$route","$ionicLoading","$localstorage","metTB",function(t,e,a,n,r,o,c,m,s,u,l,g,d,f,_,h,y,p){var b=this;e.fcastbago="sunny";var v=6e5;l(function(){f.clearCache().then(function(){b.refreshData(),_.reload(),b.getBackgroundImage("Tobago, "+e.searchTag())}),f.clearHistory()},v),n.ref_bago=function(){b.refreshData()},b.refreshData=function(){b.getCurrent(null,null),b.bago_3day(),b.set_time_bubble()},b.getCurrent=function(t,a){e.today=e.my_date(),n.$broadcast("scroll.refreshComplete")},b.cycleBgImages=function(){a(function(){if(e.bgImages){var t=Math.floor(Math.random()*e.bgImages.length)+0;e.activeBgImage=e.bgImages[t],setTimeout(function(){e.getAverageRGB(document.querySelector("#i-bago"),".bago")},2e3)}})},this.getBackgroundImage=function(t){c.search(t).then(function(t){var a=t.photos;e.bgImages=a.photo,b.cycleBgImages()},function(t){console.log("Unable to get Flickr images",t)})},n.$on("forecast_loaded",function(t,a){e.current_temp="Loading..";var n=a,r=p.all();b.mdatab=null,b.mdatab=[];var o=0;for(i=0;i<n.length;i++)"TTCP"==n[i].station&&(b.mdatab.push({id:n[i].id,label:n[i].label,station:n[i].station,value:n[i].value,icon:void 0!=r[o]?r[o].icon:"",el:void 0!=r[o]?r[o].el:"",show:void 0!=r[o]?r[o].show:""}),o++);e.current_temp=b.mdatab[2].value.substring(0,3),b.mdatab[2].txt="Looks like a "+e.cTemp(Number(e.current_temp)),b.mdatab[5].value=e.cWind(b.mdatab[5].value),e.dew_point=e.set_due_point(3,b.mdatab);var c=[];for(i=0;i<e.metars_cloud.length;i++)b.mdatab[1].value.indexOf(e.metars_cloud[i].code)>-1&&c.push(e.metars_cloud[i].code);for(e.cd,i=0;i<c.length;i++)for("FEW"==c[i]&&(e.inArray("SCT",c)||e.inArray("BKN",c)||e.inArray("OVC",c)||(e.cc="FEW")),"SCT"==c[i]&&(e.inArray("BKN",c)||e.inArray("OVC",c)||(e.cc="SCT")),e.inArray("BKN",c)&&(e.cc="BKN"),e.inArray("OVC",c)&&(e.cc="OVC"),x=0;x<e.metars_cloud.length;x++)c[c.length-1]==e.metars_cloud[x].code&&(e.cd=e.metars_cloud[x].code);var m="";for(x=0;x<e.metars_cloud.length;x++)e.cd==e.metars_cloud[x].code&&(m=e.metars_cloud[x].desc,e.summary_text=m);m||(m="Clear",e.summary_text=m);var s=new Date;if(e.fcastbago="Clear"==m?"clear-"+e.timeOfDay():m,"Clear"==m&&parseInt(s.getHours())>=0&&parseInt(s.getHours())<=5&&(e.fcastbago="clear-night"),b.mdatab[1].value.indexOf("NOSIG")>-1){var u=e.summary_text;e.summary_text=e.capFLetter(u)}else e.summary_text=e.capFLetter(b.mdatab[9].value.match(/\(([^)]+)\)/)[1]).replace("(","");if(e.summary_text.indexOf("Haze")>-1&&(e.summary_text="Dust, smoke and other dry particles may be in the air"),e.fcastbago.indexOf("Cloudy")>-1||e.fcastbago.indexOf("cloudy")>-1){var l="night"==e.timeOfDay()?"-night":"";e.fcastbago=e.fcastbago+l,parseInt(s.getHours())>=0&&parseInt(s.getHours())<=5&&(e.fcastbago=e.fcastbago+"-night")}}),b.set_time_bubble=function(){{var t=new Date;t.getDate()+"."+(t.getMonth()+1)+"."+t.getFullYear()}e.hour_of_day=e.hourOfDay()},e.showMetarsBago=function(){g.retain(),e.metbago_modal?e.metbago_modal.show():m.fromTemplateUrl("app/home/metars-bago.html",function(t){e.metbago_modal=t,e.metbago_modal.show()},{animation:"slide-in-up"})},b.bago_3day=function(t){e.tm=e.day_string(1),e.nd=e.day_string(2);var a=[];n.$on("f_cast_ready",function(t,n){a=n,b.ftime_bago=a.forecastTime,"05:30PM"==b.ftime_bago&&(y.setObject("530pm_fcast",a),b.th=a.CrownFcstMxTemp?a.CrownFcstMxTemp:" - ",b.tl=a.CrownFcstMnTemp?a.CrownFcstMnTemp:" - ",b.maxtm=a.TmCrownMxTemp,b.mintm=a.TmCrownMnTemp,e.bago_tm_icon=a.TmWeatherCpMx?a.TmWeatherCpMx:"sunny",b.max24=a.maxTob24look,b.min24=a.minTob24look,e.bago_24_icon=a.wx24cp?a.wx48cp:"sunny"),"05:30PM"!=b.ftime_bago&&(b.th=a.CrownFcstMxTemp?a.CrownFcstMxTemp:" - ",ff=y.getObject("530pm_fcast"),b.tl=a.TmCrownMnTemp?a.TmCrownMnTemp:" - ",b.maxtm=a.maxTob24look,b.mintm=a.minTob24look,e.bago_tm_icon=a.wx24cp?a.wx24cp:"sunny",b.max24=a.maxTob48look,b.min24=a.minTob48look,e.bago_24_icon=a.wx48cp?a.wx48cp:"sunny"),e.bago_icon_today=a.imagebago})},b.refreshData(),b.getBackgroundImage("Tobago, "+e.searchTag())}]);