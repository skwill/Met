angular.module("ionic.metApp").controller("HomeCtrl",function(e,t,o,n,a,c,s,l,u,d,g,m,f,h){t.activeBgImageIndex=0,t.isFlipped=!1;var b=6e5;g(function(){n.ref_trin(),n.ref_bago(),console.log("fetch info and location","cache cleared"),h.clearCache()},b),n.$on("call_test",function(){t.test()}),t.test=function(){return"LOL"},setTimeout(function(){"Tobago"==n.c&&t.flip("Tobago")},1e3),t.set_due_point=function(e,t){var o=t[e].value,n=/([0-9\.]+)%/g;return(r=n.exec(o))[0]},t.showAlert=function(e,t){d.alert({title:e,template:t})},t.flip=function(e){t.isFlipped=!t.isFlipped,"Trinidad"==e?n.ref_trin():n.ref_bago()},t.$on("$ionicView.beforeEnter",function(){console.log("before enter")}),t.closeModal=function(e){t.modal.hide()},t.$on("modal.hidden",function(){m.release()}),t.timeOfDay=function(){var e=new Date,t=e.getHours(),o="";return console.log(t),t>=0&&12>t?o="morning":t>=12&&17>t?o="mid day":t>=17&&20>t?o="evening":t>=20&&(o="night"),o},t.hourOfDay=function(){var e=new Date,t=e.getHours();return t>=0&&12>=t&&(t=(0==t?"12":t)+"am"),t>12&&(t=t-12+"pm"),t},t.my_date=function(){var e=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],t=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],o=new Date;return[t[o.getDay()],o.getDate(),e[o.getMonth()],o.getFullYear()]},t.day_string=function(e){var t=new Date,o=["Sun","Mon","Tue","Wed","Thu","Fri","Sat","Sun","Mon"];return o[t.getDay()+e]},t.convertTimestamp=function(e){var t=new Date(1e3*e),o=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],n=t.getFullYear(),i=o[t.getMonth()],a=t.getDate(),r=t.getHours(),c=t.getMinutes(),s=t.getSeconds(),l=a+" "+i+" "+n+" "+r+":"+c+":"+s;return l},t.getAverageRGB=function(e,t){var o,n,i,a,r=5,c=document.createElement("canvas"),s=c.getContext&&c.getContext("2d"),l=-4,u={r:0,g:0,b:0},d=0,g=0;if(!s)return defaultrgb;for(i=c.height=e.naturalHeight||e.offsetHeight||e.height,n=c.width=e.naturalWidth||e.offsetWidth||e.width,s.drawImage(e,0,0),o=s.getImageData(0,0,n,i),a=o.data.length;(l+=4*r)<a;)++d,u.r+=o.data[l],u.g+=o.data[l+1],u.b+=o.data[l+2],g+=.34*u.r+.5*u.g+.16*u.b,0!==g&&(g/=2);if(g>.5)var m="#FFFFFF";else var m="#000000";u.r=~~(u.r/d),u.g=~~(u.g/d),u.b=~~(u.b/d),$(t+".bar, "+t+".d3").css("background-color","rgba("+[u.r,u.g,u.b,.6].join(", ")+")"),$("#cw-summary").css("color",m),$(t+".of1").css("background-color","rgba("+[u.r,u.g,u.b,.9].join(", ")+")"),$(".item-complex").css("border-bottom","1px solid rgba("+[u.r,u.g,u.b,.4].join(", ")+")")},t.capFLetter=function(e){return e.charAt(0).toUpperCase()+e.slice(1).toLowerCase()},t.is_word_in_string=function(e,t){return new RegExp("\\b"+t+"\\b","i").test(e)},t.inArray=function(e,t){for(i=0;i<t.length;i++)if(t[i]==e)return t[i];return!1}}).controller("TrinCtrl",function(e,t,o,n,a,r,c,s,l,u,d,g,m){function f(e,t){return(" "+e.className+" ").indexOf(" "+t+" ")>-1}var h=this;t.fcasttrin="sunny",t.fcastbago="sunny",t.default_trin=t.timeOfDay(),n.ref_trin=function(){h.refreshData()},h.refreshData=function(){r.getLocation().then(function(e){var o=e.coords.latitude,i=e.coords.longitude;r.reverseGeocode(o,i).then(function(e){t.currentLocationString=e,t.country=t.currentLocationString.indexOf("Tobago")>-1?"Tobago":"Trinidad",t.$watch("country",function(){n.c=t.country}),h.getCurrent(o,i),h.get_uv_index(),h.metars_trin(),h.trin_3day()})},function(e){"The last location provider was disabled"==e.message&&(e.message=e.message+"<br> Try enabling Location services in Settings"),t.showAlert("Unable to get current location","Try enabling Location services in Settings"),t.currentLocationString="Unable to get current location:"+e,n.$broadcast("scroll.refreshComplete")})},h.getCurrent=function(e,o){a.getAtLocation(e,o).then(function(e){t.current=e.data,n.$broadcast("scroll.refreshComplete");t.timeOfDay();t.today=t.my_date(),h.getBackgroundImage("Trinidad")},function(e){var o="";switch(e.status){case 404:o="No network connection";break;case"The last location provider was disabled":o=e.status+"<br> Try enabling Location services in Settings"}t.showAlert("Unable to get current conditions",o),n.$broadcast("scroll.refreshComplete")})},h.cycleBgImages=function(){o(function(){t.bgImages&&(t.activeBgImage=t.bgImages[t.activeBgImageIndex++%t.bgImages.length+3],setTimeout(function(){t.getAverageRGB(document.querySelector("#i-trin"),".trin")},2e3))})},this.getBackgroundImage=function(e){c.search(e).then(function(e){var o=e.photos;t.bgImages=o.photo,h.cycleBgImages()},function(e){console.log("Unable to get Flickr images",e)})},h.get_uv_index=function(){var o=[],n=new Date,i=document.getElementById("uv-index"),a=n.getDate()+"."+(n.getMonth()+1)+"."+n.getFullYear();t.hour_of_day=t.hourOfDay();var r=["c1","c2","c3","c4","c5","c6","c7","c8","c9","c10","c11"];if(e.get_uv_index(function(e){for(var n=0;n<e.items.length;n++){var c=e.items[n].uv_date.trim();a==c&&o.push(e.items[n])}if(o.length){t.uv_index=o[o.length-1];var s=Number(t.uv_index.uv_value),n=s.toFixed(0);t.uv_index.uv_value=n,console.log(t.uv_index);var l=0==n||1==n?0:11==n||n>11?10:n-1;for(t.uv_color=r[l],x=0;x<r.length;x++)f(i,r[x])&&i.classList.remove(r[x]);t.$watch("uv_color",function(){i.className=i.className+"  "+t.uv_color})}}),!o.length){var c=[{uv_value:0}];t.uv_index=c[0],i.className=i.className+" c1"}},h.metars_trin=function(){t.current_temp_trin="No data",e.get_metar(function(e){var o=e.items,n=[{id:1,icon:"icon ion-ios-location-outline",el:"met-loc",show:!0},{id:2,icon:"icon ion-thermometer",el:null,show:!1},{id:3,icon:"icon ion-thermometer",el:"temp",show:!0},{id:4,icon:"icon ion-waterdrop",el:"dew",show:!0},{id:5,icon:"icon ion-ios-speedometer-outline",el:"pressure",show:!0},{id:6,icon:"icon ion-ios-analytics-outline",el:"winds",show:!0},{id:7,icon:"icon",el:"weather",show:!1},{id:8,el:"weather",show:!1},{id:9,icon:"icon ion-ios-cloudy-outline",el:"clouds",show:!0},{id:10,icon:"icon ion-umbrella",el:"weather",show:!1}];for(h.mdata=[],i=0;i<o.length;i++)"TTPP"==o[i].station&&h.mdata.push({id:o[i].id,label:o[i].label,station:o[i].station,value:o[i].value,icon:n[i].icon,el:n[i].el,show:n[i].show});t.current_temp_trin=h.mdata[2].value.substring(0,3),t.dew_point_trin=t.set_due_point(3,h.mdata);var a=[{code:"FEW",desc:"Clear"},{code:"SCT",desc:"Partly Cloudy"},{code:"BKN",desc:"Mostly Cloudy"},{code:"OVC",desc:"Overcast"},{code:"-RA",desc:"Light Rain"},{code:"-SHRA",desc:"Light Showers"},{code:"RA",desc:"Moderate Rain"},{code:"SHRA",desc:"Moderate Showers"},{code:"+RA",desc:"Heavy Rain"},{code:"+SHRA",desc:"Heavy Showers"},{code:"TS",desc:"Thunder"},{code:"-TSRA",desc:"Light Thundershowers"},{code:"TSRA",desc:"Moderate Thundershowers"},{code:"+THRA",desc:"Heavy Thundershowers"},{code:"FC",desc:"Funnel Cloud"},{code:"BR",desc:"Mist"},{code:"FG",desc:"Fog"},{code:"FU",desc:"Smoke"},{code:"HZ",desc:"Haze"},{code:"SQ",desc:"Squall"}],r=[];for(i=0;i<a.length;i++)h.mdata[1].value.indexOf(a[i].code)>-1&&(console.log(a[i].code),r.push(a[i].code));for(t.cc,i=0;i<r.length;i++)for("FEW"==r[i]&&(t.inArray("SCT",r)||t.inArray("BKN",r)||t.inArray("OVC",r)||(t.cc="FEW")),"SCT"==r[i]&&(t.inArray("BKN",r)||t.inArray("OVC",r)||(t.cc="SCT")),t.inArray("BKN",r)&&(t.cc="BKN"),t.inArray("OVC",r)&&(t.cc="OVC"),x=0;x<a.length;x++)r[r.length-1]==a[x].code&&(console.log("rains"),t.cc=a[x].code);var c="";for(x=0;x<a.length;x++)t.cc==a[x].code&&(c=a[x].desc,t.summary_text_trin=c);if(t.fcasttrin="Clear"==c?"clear-"+t.timeOfDay():c,console.debug("metars trin",r,t.cc,c,t.fcasttrin),h.mdata[1].value.indexOf("NOSIG")>-1){var s=t.summary_text_trin+" "+t.timeOfDay();t.summary_text_trin=t.capFLetter(s)}else t.summary_text_trin=t.capFLetter(h.mdata[9].value.match(/\(([^)]+)\)/)[1])})},t.showMetarsTrin=function(){g.retain(),t.mettrin_modal?t.mettrin_modal.show():s.fromTemplateUrl("app/home/metars-trin.html",function(e){t.mettrin_modal=e,t.mettrin_modal.show()},{animation:"slide-in-up"})},h.trin_3day=function(o){h.wicons=[],e.get_o_tv(function(e){var o=e.items[0];t.t="Today",t.tm=t.day_string(1),t.nd=t.day_string(2),h.max24=o.maxTrin24look,h.min24=o.minTrin24look,h.max48=o.maxTrin48look,h.min48=o.minTrin48look}),e.get_forecast(function(e){var o=e.items[0];h.ftime_trin=o.forecastTime,"05:30PM"==h.ftime_trin&&(t.t="Tonight"),h.th=o.PiarcoFcstMnTemp,h.tl=o.PiarcoFcstMxTemp,h.wicons[0]="ion-ios-partlysunny-outline",h.wicons[1]="ion-ios-partlysunny-outline",h.wicons[2]="ion-ios-partlysunny-outline"})},h.refreshData()}).controller("BagoCtrl",function(e,t,o,n,a,r,c,s,l,u,d,g,m){var f=this;n.ref_bago=function(){f.refreshData()},f.refreshData=function(){r.getLocation().then(function(e){var o=e.coords.latitude,n=e.coords.longitude;r.reverseGeocode(o,n).then(function(e){t.currentLocationString=e,f.getCurrent(o,n),f.metars_bago(),f.bago_3day(),f.set_time_bubble()})},function(e){"The last location provider was disabled"==e.message&&(e.message=e.message+"<br> Try enabling Location services in Settings"),t.showAlert("Unable to get current location","Try enabling Location services in Settings"),t.currentLocationString="Unable to get current location:"+e,n.$broadcast("scroll.refreshComplete")})},f.getCurrent=function(e,o){a.getAtLocation(e,o).then(function(e){t.current=e.data,n.$broadcast("scroll.refreshComplete");t.timeOfDay();t.today=t.my_date(),f.getBackgroundImage(t.current.currently.summary+", Tobago")},function(e){var o="";switch(e.status){case 404:o="No network connection";break;case"The last location provider was disabled":o=e.status+"<br> Try enabling Location services in Settings"}t.showAlert("Unable to get current conditions",o),n.$broadcast("scroll.refreshComplete")})},f.cycleBgImages=function(){o(function(){t.bgImages&&(t.activeBgImage=t.bgImages[t.activeBgImageIndex++%t.bgImages.length],setTimeout(function(){t.getAverageRGB(document.querySelector("#i-bago"),".bago")},2e3))})},this.getBackgroundImage=function(e){c.search(e).then(function(e){var o=e.photos;t.bgImages=o.photo,f.cycleBgImages()},function(e){console.log("Unable to get Flickr images",e)})},f.metars_bago=function(){e.get_metar(function(e){var o=e.items,n=[{id:9,icon:"icon ion-ios-location-outline",el:"met-loc",show:!0},{id:10,icon:"icon ",el:null,show:!1},{id:11,icon:"icon ion-thermometer",el:"temp",show:!0},{id:12,icon:"icon ion-waterdrop",el:"dew",show:!0},{id:13,icon:"icon ion-ios-speedometer-outline",el:"pressure",show:!0},{id:14,icon:"icon ion-ios-analytics-outline",el:"winds",show:!0},{id:15,icon:"icon ion-thermometer",el:null,show:!1},{id:16,icon:"icon ",el:null,show:!1},{id:17,icon:"icon ion-ios-cloudy-outline",el:"clouds",show:!0}];f.mdatab=null,f.mdatab=[];var a=0;for(i=0;i<o.length;i++)"TTCP"==o[i].station&&(f.mdatab.push({id:o[i].id,label:o[i].label,station:o[i].station,value:o[i].value,icon:void 0!=n[a]?n[a].icon:"",el:void 0!=n[a]?n[a].el:"",show:void 0!=n[a]?n[a].show:""}),a++);t.current_temp=f.mdatab[2].value.substring(0,3),t.dew_point=t.set_due_point(3,f.mdatab),f.mdatab[1].value.indexOf("NOSIG")>-1&&(t.summary_text="Clear "+t.timeOfDay())})},f.set_time_bubble=function(){{var e=new Date;e.getDate()+"."+(e.getMonth()+1)+"."+e.getFullYear()}t.hour_of_day=t.hourOfDay()},t.showMetarsBago=function(){g.retain(),t.metbago_modal?t.metbago_modal.show():s.fromTemplateUrl("app/home/metars-bago.html",function(e){t.metbago_modal=e,t.metbago_modal.show()},{animation:"slide-in-up"})},f.bago_3day=function(o){e.get_o_tv(function(e){var o=e.items[0];t.t="Today",t.tm=t.day_string(1),t.nd=t.day_string(2),f.max24=o.maxTbo24look,f.min24=o.minTbo24look,f.max48=o.maxTob48look,f.min48=o.minTob48look}),e.get_forecast(function(e){var o=e.items[0];f.ftime_bago=o.forecastTime,"05:30PM"==f.ftime_bago&&(t.t="Tonight"),t.fcastbago=o.imagebago?o.imagebago:"sunny",f.th=o.CrownFcstMnTemp,f.tl=o.CrownFcstMxTemp})},f.refreshData()}).directive("weatherIconTrin",function(){return{restrict:"E",link:function(e,t,o){setTimeout(function(){var t=e.fcasttrin.replace(/\s/g,"-").toLowerCase();console.debug("fcast trin",e.fcasttrin),e.getContentUrl=function(){return"app/home/svg/"+t+".html"}},2e3)},template:'<div ng-include="getContentUrl()" style="padding-top: 13px"></div>'}}).directive("weatherIconBago",function(e){return{restrict:"E",link:function(e,t,o){setTimeout(function(){var t=e.fcastbago.replace(/\s/g,"-").toLowerCase();console.debug("fcast bago",e.fcastbago),e.getContentUrl=function(){return"app/home/svg/"+t+".html"}},2e3)},template:'<div ng-include="getContentUrl()"></div>'}});