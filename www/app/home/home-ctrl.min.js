angular.module("ionic.metApp").controller("HomeCtrl",function(e,o,n,t,a,c,l,u,s,m,d,g,h){function f(e,o){var n=o[e].value,t=/([0-9\.]+)%/g;return(r=t.exec(n))[0]}function v(){var e=new Date,o=e.getHours(),n="";return o>=6&&12>o?n="morning":o>=12&&18>o?n="mid day":o>=18&&(n="night"),n}function _(){var e=new Date,o=e.getHours();return o>=0&&12>=o&&(o=(0==o?"12":o)+"am"),o>12&&(o=o-12+"pm"),o}function p(){var e=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],o=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],n=new Date;return[o[n.getDay()],n.getDate(),e[n.getMonth()],n.getFullYear()]}function b(e){var o=new Date,n=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];return n[o.getDay()+e]}var y=this;o.activeBgImageIndex=0,o.has_images=!1;var w=6e5;d(function(){o.refreshData(),console.log("fetch info and location")},w),t.$on("call_test",function(){o.test()}),o.test=function(){return"LOL"},y.get_uv_index=function(){var n=[],t=["c1","c2","c3","c4","c5","c6","c7","c8","c9","c10","c11"];e.get_uv_index(function(e){console.log("UV Index: ");var i=new Date,a=i.getDate()+"."+(i.getMonth()+1)+"."+i.getFullYear();o.hour_of_day=_();for(var r=0;r<e.items.length;r++){var c=e.items[r].uv_date.trim();a==c&&n.push(e.items[r])}if(n.length){o.uv_index=n[n.length-1];var l=Number(o.uv_index.uv_value),r=l.toFixed(0);o.uv_index.uv_value=r,console.log(o.uv_index);var u=0==r||1==r?0:11==r||r>11?10:r-1;o.uv_color=t[u],o.$watch("uv_color",function(){var e=document.getElementById("uv-index");e.className=e.className+" "+o.uv_color,console.log("uv color value",o.uv_color,u,r),console.log("watch on uv_value updated")})}})},y.get_uv_index(),y.metars_trin=function(){e.get_metar(function(e){var n=e.items;o.current_temp=n[2].value.substring(0,3),o.dew_point=f(3,n);var t=[{id:0,icon:"icon ion-ios-location-outline",el:"met-loc"},{id:2,icon:"icon ion-thermometer",el:"temp"},{id:3,icon:"icon ion-waterdrop",el:"dew"},{id:4,icon:"icon ion-ios-speedometer-outline",el:"pressure"},{id:5,icon:"icon ion-ios-analytics-outline",el:"winds"},{id:8,icon:"icon ion-ios-cloudy-outline",el:"clouds"},{id:9,icon:"icon ion-umbrella",el:"weather"}];for(o.summary_text=n[1].value.indexOf("NOSIG")>-1?"Clear "+v():"",y.mdata=[],i=0;i<t.length;i++)y.mdata.push({id:n[t[i].id].id,label:n[t[i].id].label,station:n[t[i].id].station,value:n[t[i].id].value,icon:t[i].icon,el:t[i].el})})},y.metars_bago=function(){e.get_metar(function(e){var n=e.items;o.current_temp=n[11].value.substring(0,3),o.dew_point=f(12,n),o.summary_text=n[10].value.indexOf("NOSIG")>-1?"Clear "+v():n[19].value;var t=[{id:10,icon:"icon ion-ios-location-outline",el:"met-loc"},{id:12,icon:"icon ion-thermometer",el:"temp"},{id:13,icon:"icon ion-waterdrop",el:"dew"},{id:14,icon:"icon ion-ios-speedometer-outline",el:"pressure"},{id:15,icon:"icon ion-ios-analytics-outline",el:"winds"},{id:18,icon:"icon ion-ios-cloudy-outline",el:"clouds"},{id:19,icon:"icon ion-umbrella",el:"weather"}];for(y.mdatab=null,y.mdatab=[],i=0;i<t.length;i++)y.mdatab.push({id:n[t[i].id].id,label:n[t[i].id].label,station:n[t[i].id].station,value:n[t[i].id].value,icon:t[i].icon,el:t[i].el});console.error(o.country,y.mdatab)})},y.forecast=function(n){e.get_o_tv(function(e){console.log("outlook tv");var n=e.items[0];console.log(e),o.t=b(0),o.tm=b(1),o.nd=b(2),y.max24=n.maxTrin24look,y.min24=n.minTrin24look,y.max48=n.maxTrin48look,y.min48=n.minTrin48look,"Tobago"==o.country&&(y.max24=n.maxTbo24look,y.min24=n.minTbo24look,y.max48=n.maxTob48look,y.min48=n.minTob48look,console.debug("48",y.max48)),console.log("country",o.country)}),e.get_forecast(function(e){var n=e.items[0];o.fcast=n.imageTrin,"Tobago"==o.country&&(o.fcast=n.imagebago)})},y.getCurrent=function(e,n,i){a.getAtLocation(e,n).then(function(e){o.current=e.data,t.$broadcast("scroll.refreshComplete");v();o.today=p(),console.log("currently",o.current),y.getBackgroundImage(o.current.currently.summary+", "+i)},function(e){var n="";switch(e.status){case 404:n="No network connection";break;case"The last location provider was disabled":n=e.status+"<br> Try enabling Location services in Settings"}o.showAlert("Unable to get current conditions",n),t.$broadcast("scroll.refreshComplete")})},o.change_country=function(){},o.refreshData=function(){c.getLocation().then(function(e){var n=e.coords.latitude,t=e.coords.longitude;c.reverseGeocode(n,t).then(function(e){o.currentLocationString=e,o.country||(o.country=o.currentLocationString.indexOf("Tobago")>-1?"Tobago":"Trinidad"),"Trinidad"==o.country&&y.metars_trin(),"Tobago"==o.country&&(y.metars_bago(),console.warn("met for",o.country)),y.forecast(o.country),"Trinidad"==o.country&&y.get_uv_index(),y.getCurrent(n,t,o.country)})},function(e){"The last location provider was disabled"==e.message&&(e.message=e.message+"<br> Try enabling Location services in Settings"),o.showAlert("Unable to get current location","Try enabling Location services in Settings"),o.currentLocationString="Unable to get current location:"+e,t.$broadcast("scroll.refreshComplete")})},o.showAlert=function(e,o){m.alert({title:e,template:o})},y.cycleBgImages=function(){n(function(){o.bgImages&&(o.activeBgImage=o.bgImages[o.activeBgImageIndex++%o.bgImages.length])})},this.getBackgroundImage=function(e){o.bgImages;o.has_images?y.cycleBgImages():l.search(e).then(function(e){var n=e.photos,t=[];if(n.photo.length){for(o.bgImages=n.photo,i=0;i<20;i++)t.push({i:o.bgImages[i]});y.cycleBgImages(),o.has_images=!0}},function(e){console.log("Unable to get Flickr images",e)})},o.refreshData(),o.isFlipped=!1,o.flip=function(e){o.isFlipped=!o.isFlipped,console.log("show data for",e),o.country=e,o.refreshData()},o.showHomeMenu=function(){g.retain(),o.home_menu_modal1?o.home_menu_modal1.show():u.fromTemplateUrl("app/home/home_menu.html",function(e){o.home_menu_modal1=e,o.home_menu_modal1.show()},{animation:"slide-in-up"})},o.showHomeMenu_bago=function(){g.retain(),o.home_menu_modal2?o.home_menu_modal2.show():u.fromTemplateUrl("app/home/home_menu-bago.html",function(e){o.home_menu_modal2=e,o.home_menu_modal2.show()},{animation:"slide-in-up"})},o.closeModal=function(e){o.modal.hide()},o.$on("modal.hidden",function(){g.release()}),o.uv_modalOpen=function(){g.retain(),o.uv_modal?o.uv_modal.show():u.fromTemplateUrl("app/home/uv_modal.html",function(e){o.uv_modal=e,o.uv_modal.show()},{animation:"slide-in-up"})}}).directive("dayIcon",function(e){return{restrict:"E",replace:!0,templateUrl:"app/home/svg/icon-sunny.html",link:function(e,o,n){}}}).controller("TrinCtrl",function(e,o,n,t,i,a,r,c,l,u,s,m,d){}).controller("BagoCtrl",function(e,o,n,t,i,a,r,c,l,u,s,m,d){}).controller("SettingsCtrl",function(e,o){e.setings=o.getSettings(),e.$watch("settings",function(e){o.save()},!0),e.closeSettings=function(){e.modal.hide(),o.save()},e.changeCurrentTemp=function(e){o.set("tempUnits",e),o.save(e)}});